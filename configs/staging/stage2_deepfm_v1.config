# Stage2 DeepFM v1 (2025-09-29): 基于赛题数据的高阶特征交叉配置，目标优化F1。
# 2025-09-29 fix: 切换数据输入为 FG_NORMAL，避免 event_day 等特征索引越界。
# 2025-09-29 update: 使用 next-day 标签数据集（行为预测次日购买）。
# 2025-09-30 tuning: 调整学习率衰减、训练轮次、Dropout 与正则，提升线上召回。
# 2025-09-30 activation: 深层与汇合层改用 nn.SiLU，提高梯度平滑性。
train_input_path: "data/processed/20141218_v2_train.parquet"
eval_input_path: "data/processed/20141218_v2_eval.parquet"
model_dir: "models/stage2_deepfm_v10"
train_config {
  sparse_optimizer {
    rowwise_adagrad_optimizer {
      lr: 0.0025
  }
    exponential_decay_learning_rate {
      decay_size: 1
      decay_factor: 0.85
      warmup_learning_rate: 0.001
      warmup_size: 1
      by_epoch: true
      min_learning_rate: 0.0005
    }
}
dense_optimizer {
  adam_optimizer {
      lr: 0.00025
    beta1: 0.9
    beta2: 0.999
      weight_decay: 5e-06
  }
    exponential_decay_learning_rate {
      decay_size: 1
      decay_factor: 0.8
      warmup_learning_rate: 0.00015
      warmup_size: 1
      by_epoch: true
      min_learning_rate: 0.00005
    }
}
  num_epochs: 8
save_checkpoints_steps: 5000
}
eval_config {
}
data_config {
  batch_size: 32768
  dataset_type: ParquetDataset
  label_fields: "is_buy"
  num_workers: 12
  fg_mode: FG_NORMAL
  shuffle: true
}
feature_configs {
  id_feature {
    feature_name: "user_id"
    expression: "user:user_id"
    embedding_dim: 16
    hash_bucket_size: 12000000
  }
}
feature_configs {
  id_feature {
    feature_name: "item_id"
    expression: "item:item_id"
    embedding_dim: 16
    hash_bucket_size: 8000000
  }
}
feature_configs {
  id_feature {
    feature_name: "item_category"
    expression: "item:item_category"
    embedding_dim: 16
    hash_bucket_size: 10000000
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "behavior_type"
    expression: "context:behavior_type"
    embedding_dim: 16
    hash_bucket_size: 16
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "event_day"
    expression: "context:event_day_index"
    embedding_dim: 16
    hash_bucket_size: 64
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "event_hour"
    expression: "context:event_hour"
    embedding_dim: 16
    hash_bucket_size: 32
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "user_geohash"
    expression: "user:user_geohash"
    embedding_dim: 16
    hash_bucket_size: 40000000
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_click"
    expression: "user:user_click"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_fav"
    expression: "user:user_fav"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_cart"
    expression: "user:user_cart"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_buy"
    expression: "user:user_buy"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_click"
    expression: "item:item_click"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_fav"
    expression: "item:item_fav"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_cart"
    expression: "item:item_cart"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_buy"
    expression: "item:item_buy"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
model_config {
  feature_groups {
    group_name: "wide"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    group_type: WIDE
  }
  feature_groups {
    group_name: "fm"
    feature_names: "user_id"
    feature_names: "item_id"
    feature_names: "item_category"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    group_type: DEEP
  }
  feature_groups {
    group_name: "deep"
    feature_names: "user_id"
    feature_names: "item_id"
    feature_names: "item_category"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    feature_names: "user_click"
    feature_names: "user_fav"
    feature_names: "user_cart"
    feature_names: "user_buy"
    feature_names: "item_click"
    feature_names: "item_fav"
    feature_names: "item_cart"
    feature_names: "item_buy"
    group_type: DEEP
  }
  deepfm {
    deep {
      hidden_units: 512
      hidden_units: 256
      hidden_units: 128
      hidden_units: 64
      activation: "nn.SiLU"
      dropout_ratio: 0.2
      dropout_ratio: 0.2
      dropout_ratio: 0.1
      dropout_ratio: 0.1
    }
    final {
      hidden_units: 64
      activation: "nn.SiLU"
      dropout_ratio: 0.1
    }
  }
  metrics {
    auc {}
  }
  losses {
    binary_cross_entropy {
    }
  }
}

