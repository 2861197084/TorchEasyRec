# Stage2 DeepFM v1 (2025-09-29): 基于赛题数据的高阶特征交叉配置，目标优化F1。
# 2025-09-29 fix: 切换数据输入为 FG_NORMAL，避免 event_day 等特征索引越界。
# 2025-09-29 update: 使用 next-day 标签数据集（行为预测次日购买）。
train_input_path: "data/processed/20141218_next_train.parquet"
eval_input_path: "data/processed/20141218_next_eval.parquet"
model_dir: "models/stage2_deepfm_v5"
train_config {
  sparse_optimizer {
    rowwise_adagrad_optimizer {
      lr: 0.005
  }
  constant_learning_rate {}
}
dense_optimizer {
  adam_optimizer {
    lr: 0.0003
    beta1: 0.9
    beta2: 0.999
    weight_decay: 1e-06
  }
  constant_learning_rate {}
}
num_epochs: 2
save_checkpoints_steps: 8000
}
eval_config {
  num_steps: 5000
}
data_config {
  batch_size: 32768
  dataset_type: ParquetDataset
  label_fields: "is_buy"
  num_workers: 12
  fg_mode: FG_NORMAL
  shuffle: true
}
feature_configs {
  id_feature {
    feature_name: "user_id"
    expression: "user:user_id"
    embedding_dim: 16
    hash_bucket_size: 12000000
  }
}
feature_configs {
  id_feature {
    feature_name: "item_id"
    expression: "item:item_id"
    embedding_dim: 16
    hash_bucket_size: 8000000
  }
}
feature_configs {
  id_feature {
    feature_name: "item_category"
    expression: "item:item_category"
    embedding_dim: 16
    hash_bucket_size: 10000000
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "behavior_type"
    expression: "context:behavior_type"
    embedding_dim: 16
    hash_bucket_size: 16
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "event_day"
    expression: "context:event_day_index"
    embedding_dim: 16
    hash_bucket_size: 64
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "event_hour"
    expression: "context:event_hour"
    embedding_dim: 16
    hash_bucket_size: 32
    default_value: "0"
  }
}
feature_configs {
  id_feature {
    feature_name: "user_geohash"
    expression: "user:user_geohash"
    embedding_dim: 16
    hash_bucket_size: 40000000
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_click_7d"
    expression: "user:user_click_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_fav_7d"
    expression: "user:user_fav_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_cart_7d"
    expression: "user:user_cart_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "user_buy_7d"
    expression: "user:user_buy_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_click_7d"
    expression: "item:item_click_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_fav_7d"
    expression: "item:item_fav_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_cart_7d"
    expression: "item:item_cart_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
feature_configs {
  raw_feature {
    feature_name: "item_buy_7d"
    expression: "item:item_buy_7d"
    normalizer: "method=expression,expr=log(x+1)"
    default_value: "0"
  }
}
model_config {
  feature_groups {
    group_name: "wide"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    feature_names: "user_geohash"
    group_type: WIDE
  }
  feature_groups {
    group_name: "fm"
    feature_names: "user_id"
    feature_names: "item_id"
    feature_names: "item_category"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    feature_names: "user_geohash"
    group_type: DEEP
  }
  feature_groups {
    group_name: "deep"
    feature_names: "user_id"
    feature_names: "item_id"
    feature_names: "item_category"
    feature_names: "behavior_type"
    feature_names: "event_day"
    feature_names: "event_hour"
    feature_names: "user_geohash"
    group_type: DEEP
  }
  deepfm {
    deep {
      hidden_units: 512
      hidden_units: 256
      hidden_units: 128
    }
    final {
      hidden_units: 64
    }
  }
  metrics {
    auc {}
  }
  losses {
    binary_cross_entropy {
    }
  }
}

